/**
 * DubStash
 * Copyright (c) 2013 - 2015 Itzy Sabo
 * Licensed under the MIT License: https://github.com/isabo/DubStash/blob/master/LICENSE
 */
(function(){var h=this;function k(b,a){var c=b.split("."),d=h;c[0]in d||!d.execScript||d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)c.length||void 0===a?d[e]?d=d[e]:d=d[e]={}:d[e]=a};function l(b){this.a=b}l.prototype.j=function(){var b=this;return function(){return b.a}};l.prototype.g=function(){return["function(){",'    return "'+this.a.replace(n,"\\\\").replace(p,'\\"').replace(q,"\\n")+'";',"}"].join("\n")};var p=/"/g,q=/\r?\n/g,n=/\\/g;function r(b,a,c){this.l=b;this.i=a;this.h=c};function t(){}t.a=function(){return t.b?t.b:t.b=new t};t.prototype.c={};t.prototype.b={};function u(b,a,c,d,e){b=e||new r(c,"",c);c=[];for(var f in a)c.push(a[f].call(null,b,d));return c.join("")}function v(b,a,c,d,e,f){var g=w(b,a,e);if(f&&void 0===g)return d?"{{"+a+"}}":"{{{"+a+"}}}";if(void 0===g||null===g)return"";a=d?(""+g).replace(x,"&amp;").replace(y,"&lt;").replace(z,"&gt;").replace(A,"&quot;"):""+g;c&&-1!==a.indexOf("{{")&&(a=B(b,a).call(null,e.h,f,e));return a}
function C(b,a,c,d,e,f,g){(a=w(b,a,f))&&c&&"{{"===a.slice(0,2)&&"}}"===a.slice(-2)&&(a=B(b,a).call(null,f.h,!1,f));b=a?d:e;c=[];for(var m in b)c.push(b[m].call(null,f,g));return c.join("")}function D(b,a,c,d,e){var f=w(b,a,d),g=[];if(f){a=d.i.length?d.i+"."+a:a;var m=new r(null,a+".[item]",d.h);E(b,f,function(a){for(var b in c)m.l=a,g.push(c[b].call(null,m,e))})}return g.join("")}function B(b,a){var c;a&&(c=b.f[a]);c||(c=F(a),b.f[a]=c);return c}t.prototype.f={};
function w(b,a,c){var d=a,e=c;if(c=d.split("../").length-1){var f=e.i.split("."),g=f.length-c-1;-1>g&&(console.log("Too many levels to climb from "+e.i+" to "+d+". Will stop at the top."),g=-1);-1!==g?(f=f.slice(0,g+1).join("."),g=w(b,f,new r(e.h,"",e.h))):(f="",g=e.h);e=new r(g,f,e.h);e.name=d.slice(3*c);c=e}else c=e;if(c.name){a=c.name;var m=!0}d=new r(c.l,c.i,c.h);e=a.split(".");f=e.length-1;for(g=0;g<f;g++){var G=H(b,d,e[g]);if(void 0!==G){var T=d.i?[d.i,e[g]].join("."):e[g];d.l=G;d.i=T}else return c===
b.a||m?void 0:w(b,a,b.a)}d=H(b,d,e[f]);c===b.a||m||void 0!==d||(d=w(b,a,b.a));return d}function H(b,a,c){var d=a.l,e;if(null!==d){c in d?e="function"===typeof d[c]?d[c]():d[c]:(b=b.c[c])&&(e=b.call(null,a.h,void 0,a));if("object"===typeof e){if(e instanceof Array)return e.length?e:null;for(var f in e)return e;return null}return e}}
function E(b,a,c){if("function"===typeof a.forEach)a.forEach(c);else if("function"===typeof a.s){a=a.s(!1);for(var d=!1;!d;){try{var e=a.next()}catch(f){d=!0}d||c.call(b,e)}}else if("object"===typeof a)for(d in a)c.call(b,a[d]);else c.call(b,a)}var y=/</g,z=/>/g,x=/&/g,A=/\"/g;t.prototype.a=new r(t.a().b,"",t.a().b);function I(b,a){this.f=b;this.c=a;this.o=!1;this.b=[];this.a=[]}I.prototype.m=function(b){(this.o?this.a:this.b).push(b)};I.prototype.j=function(){var b=this.f,a=this.c,c=J(this.b),d=J(this.a);return function(e,f){return C(t.a(),b,a,c,d,e,f)}};I.prototype.g=function(){return["function(c, i){",'    var n = "'+this.f+'";',"    var r = "+this.c+";","    var t = ["+K(this.b).toString()+"];","    var f = ["+K(this.a).toString()+"];","    return DubStash.C(n, r, t, f, c, i);\n}"].join("\n")};
function J(b){var a=[],c;for(c in b)a.push(b[c].j());return a}function K(b){var a=[],c;for(c in b)a.push(b[c].g());return a};function L(b){this.b=b;this.a=[]}L.prototype.j=function(){var b=this;return function(a,c){var d=t.a(),e=b.b,f=[],g;for(g in b.a)f.push(b.a[g].j());return D(d,e,f,a,c)}};L.prototype.g=function(){return["function(c, i){",'    var n = "'+this.b+'";',"    var s = ["+M(this).toString()+"];","    return DubStash.I(n, s, c, i);\n}"].join("\n")};L.prototype.m=function(b){this.a.push(b)};function M(b){var a=[],c;for(c in b.a)a.push(b.a[c].g());return a};function N(b,a,c){this.c=b;this.b=a;this.a=c}N.prototype.j=function(){var b=this;return function(a,c){return v(t.a(),b.c,b.b,b.a,a,c)}};N.prototype.g=function(){return["function(c, i){","    return DubStash.P("+['"'+this.c+'"',this.b,this.a].join(", ")+", c, i);","}"].join("\n")};function O(b){this.c=b;this.a=[];this.f=0;this.b=[]}O.prototype.j=function(){P(this);var b=Q(this);return function(a,c,d){return u(t.a(),b,a,c,d)}};O.prototype.g=function(){P(this);var b=[],a;for(a in this.b)b.push(this.b[a].g());return["function(d, i, s){","    var r = ["+b.toString()+"];","    return DubStash.T(r, d, i, s);\n}"].join("\n")};function Q(b){var a=[],c;for(c in b.b)a.push(b.b[c].j());return a}
function P(b){R.lastIndex=0;for(var a;null!==(a=R.exec(b.c));)if(a[1].length===a[5].length){var c;S(b,a);switch(a[2]){case "if":a[3]?(c="/r"===a[4],a=new I(a[3],c),U(b,a),b.a.push(a)):console.log("Bad condition: "+a[0]);break;case "foreach":a[3]&&(a=new L(a[3]),U(b,a),b.a.push(a));break;case "else":c=!1;if(b.a.length){var d=b.a[b.a.length-1];d instanceof I?d.o=!0:c=!0}else c=!0;c&&(S(b,a[0]),console.log("Unexpected {{else}} encountered!"));break;case "end":c=!1;b.a.length?a[3]&&(d=b.a[b.a.length-
1],c="if"===a[3]?!(d instanceof I):"foreach"===a[3]?!(d instanceof L):!0):c=!0;c?(S(b,a[0]),console.log("Unexpected {{end}} encountered!")):b.a.pop();break;default:d=2===a[1].length,c="/r"===a[3],a=new N(a[2],c,d),U(b,a)}}else console.log("Unbalanced brackets encountered: "+a[0]);a=[];a.index=b.c.length;S(b,a);b.a.length&&console.log("Missing {{end}}!")}function S(b,a){var c="string"===typeof a?a:b.c.slice(b.f,a.index);c.length?U(b,new l(c)):b.f=R.lastIndex}
function U(b,a){b.a.length?b.a[b.a.length-1].m(a):b.b.push(a);b.f=R.lastIndex}var R=/(\{{2,3})\s*([^\}\s]*)\s*([^\}\s]*)?\s*([^\}\s]*)?(\}{2,3})/g;k("DubStash.VERSION","1.0.0");function F(b){return(new O(b)).j()}k("DubStash.compile",F);k("DubStash.precompile",function(b){return(new O(b)).g()});k("DubStash.registerGlobalTemplate",function(b,a){var c=t.a(),d=F(a);c.c[b]=d;V[b]=a});var V={};k("DubStash.precompileGlobalTemplates",function(){var b=[""],a;for(a in V)b.push("DubStash.G('"+a+"', "+(new O(V[a])).g()+");");return b.join("\n")});k("DubStash.registerGlobalData",function(b,a){t.a().b[b]=a});
k("DubStash.createContext",function(b,a,c){return new r(b,a,c)});k("DubStash.G",function(b,a){t.a().c[b]=a});k("DubStash.T",function(b,a,c,d){return u(t.a(),b,a,c,d)});k("DubStash.P",function(b,a,c,d,e){return v(t.a(),b,a,c,d,e)});k("DubStash.C",function(b,a,c,d,e,f){return C(t.a(),b,a,c,d,e,f)});k("DubStash.I",function(b,a,c,d){return D(t.a(),b,a,c,d)});"undefined"!==typeof module&&module.exports&&(module.exports=h.DubStash);})();

