/*
 Copyright (c) 2013 - 2015 Itzy Sabo
 This file is licensed under the terms of the MIT License, a copy of which can be found at:
 https://github.com/isabo/DubStash/blob/master/LICENSE
*/
(function(){function m(a,b,c){this.u=a;this.i=b;this.h=c}function n(a){this.b=a;this.a=[]}function k(a,b){this.f=a;this.c=b;this.s=!1;this.b=[];this.a=[]}function q(a,b,c){this.b=a;this.a=b;this.w=c}function h(a){this.a=a}function f(a){this.l=a;this.a=[];this.o=0;this.b=[]}var p={VERSION:"1.0.0.rc7",compile:function(a){return(new f(a)).j()},precompile:function(a){return(new f(a)).g()},registerGlobalTemplate:function(a,b){e.L(a,p.compile(b));this.B[a]=b},B:{},precompileGlobalTemplates:function(){var a=
[""],b;for(b in this.B)a.push("DubStash.R.G('"+b+"', "+(new f(this.B[b])).g()+");");return a.join("\n")},registerGlobalData:function(a,b){e.registerGlobalData(a,b)},createContext:function(a,b,c){return new m(a,b,c)}};f.prototype.j=function(){this.s();var a=this.aa();return function(b,c,d){return e.S(a,b,c,d)}};f.prototype.g=function(){this.s();return["function(d, i, s){","\tvar r = ["+this.D().toString()+"];","\treturn DubStash.R.T(r, d, i, s);\n}"].join("\n")};f.prototype.aa=function(){var a=[],
b;for(b in this.b)a.push(this.b[b].j());return a};f.prototype.D=function(){var a=[],b;for(b in this.b)a.push(this.b[b].g());return a};f.prototype.s=function(){f.a.lastIndex=0;for(var a;null!==(a=f.a.exec(this.l));)if(a[1].length===a[5].length){var b;this.f(a);switch(a[2]){case "if":a[3]?(b="/r"===a[4],a=new k(a[3],b),this.c(a),this.a.push(a)):console.log("Bad condition: "+a[0]);break;case "foreach":a[3]&&(a=new n(a[3]),this.c(a),this.a.push(a));break;case "else":b=!1;if(this.a.length){var c=this.a[this.a.length-
1];c instanceof k?c.D():b=!0}else b=!0;b&&(this.f(a[0]),console.log("Unexpected {{else}} encountered!"));break;case "end":b=!1;this.a.length?a[3]&&(c=this.a[this.a.length-1],b="if"===a[3]?!(c instanceof k):"foreach"===a[3]?!(c instanceof n):!0):b=!0;b?(this.f(a[0]),console.log("Unexpected {{end}} encountered!")):this.a.pop();break;default:c=2===a[1].length,b="/r"===a[3],a=new q(a[2],b,c),this.c(a)}}else console.log("Unbalanced brackets encountered: "+a[0]);a=[];a.index=this.l.length;this.f(a);this.a.length&&
console.log("Missing {{end}}!")};f.prototype.f=function(a){a="string"===typeof a?a:this.l.slice(this.o,a.index);a.length?this.c(new h(a)):this.o=f.a.lastIndex};f.prototype.c=function(a){this.a.length?this.a[this.a.length-1].F(a):this.b.push(a);this.o=f.a.lastIndex};f.a=/(\{{2,3})\s*([^\}\s]*)\s*([^\}\s]*)?\s*([^\}\s]*)?(\}{2,3})/g;h.prototype.j=function(){var a=this;return function(){return a.a}};h.prototype.g=function(){return["function(){",'\treturn "'+this.b()+'";',"}"].join("\n")};h.b=/"/g;h.c=
/\r?\n/g;h.a=/\\/g;h.prototype.b=function(){return this.a.replace(h.a,"\\\\").replace(h.b,'\\"').replace(h.c,"\\n")};q.prototype.j=function(){var a=this;return function(b,c){return e.O(a.b,a.a,a.w,b,c)}};q.prototype.g=function(){return["function(c, i){","\treturn DubStash.R.P("+['"'+this.b+'"',this.a,this.w].join(", ")+", c, i);","}"].join("\n")};k.prototype.D=function(){this.s=!0};k.prototype.F=function(a){(this.s?this.a:this.b).push(a)};k.prototype.j=function(){var a=this.f,b=this.c,c=this.o(this.b),
d=this.o(this.a);return function(g,l){return e.M(a,b,c,d,g,l)}};k.prototype.g=function(){return["function(c, i){",'\tvar n = "'+this.f+'";',"\tvar r = "+this.c+";","\tvar t = ["+this.l(this.b).toString()+"];","\tvar f = ["+this.l(this.a).toString()+"];","\treturn DubStash.R.C(n, r, t, f, c, i);\n}"].join("\n")};k.prototype.o=function(a){var b=[],c;for(c in a)b.push(a[c].j());return b};k.prototype.l=function(a){var b=[],c;for(c in a)b.push(a[c].g());return b};n.prototype.j=function(){var a=this;return function(b,
c){return e.N(a.b,a.f(),b,c)}};n.prototype.g=function(){return["function(c, i){",'\tvar n = "'+this.b+'";',"\tvar s = ["+this.c().toString()+"];","\treturn DubStash.R.I(n, s, c, i);\n}"].join("\n")};n.prototype.F=function(a){this.a.push(a)};n.prototype.f=function(){var a=[],b;for(b in this.a)a.push(this.a[b].j());return a};n.prototype.c=function(){var a=[],b;for(b in this.a)a.push(this.a[b].g());return a};var e={L:function(a,b){this.K[a]=b},K:{},registerGlobalData:function(a,b){this.A[a]=b},A:{},
S:function(a,b,c,d){b=d||new m(b,"",b);d=[];for(var g in a)d.push(a[g].call(null,b,c));return d.join("")},O:function(a,b,c,d,g){var l=e.m(a,d);if(g&&void 0===l)return c?"{{"+a+"}}":"{{{"+a+"}}}";if(void 0===l||null===l)return"";a=c?e.w(""+l):""+l;b&&-1!==a.indexOf("{{")&&(a=this.H(a).call(null,d.h,g,d));return a},M:function(a,b,c,d,g,l){(a=e.m(a,g))&&b&&"{{"===a.slice(0,2)&&"}}"===a.slice(-2)&&(a=this.H(a).call(null,g.h,!1,g));b=a?c:d;c=[];for(var f in b)c.push(b[f].call(null,g,l));return c.join("")},
N:function(a,b,c,d){var g=e.m(a,c),f=[];if(g){a=c.i.length?c.i+"."+a:a;var h=new m(null,a+".[item]",c.h);this.Z(g,function(a){for(var c in b)h.u=a,f.push(b[c].call(null,h,d))})}return f.join("")},H:function(a){var b;a&&(b=this.U[a]);b||(b=p.compile(a),this.U[a]=b);return b},U:{},m:function(a,b){b=this.$(a,b);if(b.name){a=b.name;var c=!0}for(var d=new m(b.u,b.i,b.h),g=a.split("."),e=g.length-1,f=0;f<e;f++){var h=this.J(d,g[f]);if(void 0!==h){var k=d.i?[d.i,g[f]].join("."):g[f];d.u=h;d.i=k}else return b===
this.v||c?void 0:this.m(a,this.v)}d=this.J(d,g[e]);b===this.v||c||void 0!==d||(d=this.m(a,this.v));return d},J:function(a,b){var c=a.u,d;if(null!==c){b in c?d="function"===typeof c[b]?c[b]():c[b]:(c=this.K[b])&&(d=c.call(null,a.h,void 0,a));if("object"===typeof d){if(d instanceof Array)return d.length?d:null;for(var e in d)return d;return null}return d}},$:function(a,b){var c=a.split("../").length-1;if(c){var d=b.i.split("."),e=d.length-c-1;-1>e&&(console.log("Too many levels to climb from "+b.i+
" to "+a+". Will stop at the top."),e=-1);-1!==e?(d=d.slice(0,e+1).join("."),e=this.m(d,new m(b.h,"",b.h))):(d="",e=b.h);d=new m(e,d,b.h);d.name=a.slice(3*c);return d}return b},Z:function(a,b){if("function"===typeof a.forEach)a.forEach(b);else if("function"===typeof a.__iterator__)for(var c=a.__iterator__(!1),d=!1;!d;){try{var e=c.next()}catch(f){d=!0}d||b.call(this,e)}else if("object"===typeof a)for(c in a)b.call(this,a[c]);else b.call(this,a)},w:function(a){return a.replace(e.V,"&amp;").replace(e.X,
"&lt;").replace(e.W,"&gt;").replace(e.Y,"&quot;")},X:/</g,W:/>/g,V:/&/g,Y:/\"/g};e.v=new m(e.A,"",e.A);p.R=e;e.T=e.S;e.P=e.O;e.C=e.M;e.I=e.N;e.G=e.L;this.DubStash=p;try{module.exports=p}catch(a){}})();
